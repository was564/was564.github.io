# DirectX11 Study

------

## 이론 편

DirectX11을 기준으로 기록합니다.

DirectX11의 설치를 위해 아래 사이트에서 설치 후 visual studio에서 빈 프로젝트를 생성한 후
https://www.microsoft.com/ko-kr/download/details.aspx?id=35

<B>프로젝트 속성 >> VC++ 디렉토리 >> 포함 디렉토리</B>에
<B>C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\Include</B>를 추가한다.

그리고 <B>라이브러리 디렉토리</B>에는
<B>C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\Lib\x86</B>를 추가한다.

### XNAMATH 라이브러리
DirectX10에는 d3dx10.h 파일에 기본적으로 벡터에 관련된 수학 라이브러리가 포함되어 있지만  
DirectX11부터는 xnamath.h라는 파일로 개별적으로 제공한다.  

xnamath.h 파일을 include 하면 문제가 생길 수 있는데  
이 때는 xnamath.h를 include하기 전에 Windows.h 혹은 d3d11.h를 include하면 해결이 된다.  
이유는 xnamath.h에서 FLOAT UINT 등의 타입을 정의하는데 해당 타입을 찾지 못하기 때문이다.  

### Direct3D
3차원 그래픽 가속 기능을 이용하여 렌더링을 하는 저수준 API

### COM (Component Object Model)
DirectX의 프로그래밍 언어 독립성과 하위 호환성을 가능하게 하는 기술
COM 객체를 흔히 인터페이스라고 지칭함
그리고 COM 인터페이스는 new 키워드로 생성하지 않고 메소드로 생성하며
메모리 해제도 delete가 아닌 Release 메소드를 이용하여 해제한다.
개인적인 생각으로는 해당 DirectX를 쉽게 사용하기 위한 API의 구성 요소 혹은 객체 한정 프레임워크인 듯하다

### 텍스처 및 자료 자원 형식
DXGI_FORMAT_R32G32B32_FLOAT
DXGI_FORMAT_R16G16B16_UNORM
DXGI_FORMAT_R32G32_UINT
DXGI_FORMAT_R8G8B8A8_UNORM
DXGI_FORMAT_R8G8B8A8_SNORM
DXGI_FORMAT_R8G8B8A8_SINT
DXGI_FORMAT_R8G8B8A8_UINT

### 교환 사슬, 페이지 전환
이중 버퍼링 설명이며
모니터에 띄워주는 화면 버퍼가 2개를 만들어 전면 버퍼, 후면 버퍼가 있는데 서로 번갈아 바꾸면서 화면에 띄우는 것을 말한다.
그리고 전면 버퍼와 후면 버퍼를 연결하기 위한 교환 사슬(swap chain)이 존재하며
대표적으로 IDXGISwapChain이라는 인터페이스로 이용된다.
위 설명에서 버퍼를 2개가 아닌 3개로 바꾸면 삼중 버퍼링이 되며 일반적으로는 이중 버퍼링이면 충분하다.

### 깊이 버퍼링
깊이 버퍼는 각 픽셀의 깊이 정보를 담는 버퍼이며 깊이는 관찰자와 가까운 값인 0.0부터 먼 값인 1.0 사이의 값으로 이루어진다.
Direct3D는 물체의 깊이 판정을 위해 해당 내용인 깊이 버퍼링 또는 z-버퍼링 기법을 이용한다.
참고로 깊이 버퍼링은 픽셀의 깊이에 따라 그려지므로 물체들을 그리는 순서가 중요하지 않다.

깊이 버퍼는 일종의 텍스트이며 특정 자료 형식을 지정 후 생성해야 한다.
아래는 깊이 버퍼링에 대한 텍스처 형식이다.
1. DXGI_FORMAT_D32_FLOAT_S8X24_UINT
2. DXGI_FORMAT_D32_FLOAT
3. DXGI_FORMAT_D24_UNORM_S8_UINT
4. DXGI_FORMAT_D16_UNORM

참고로 응용 프로그램은 무조건 스텐실 버퍼를 사용해야 하는 것은 아니다.
하지만 스텐실 버퍼를 사용하기 위해서는 깊이 버퍼에 부착해야 한다.
스텐실 버퍼는 마스크 픽셀로 후면 버퍼에서 그릴지 말지 결정하는 픽셀(텍셀) 마스크이다.

### 텍스처 자원 뷰
렌더링 파이프라인에는 텍스처를 bind하는 단계들이 여럿 있으며 흔한 용도로는 아래 2가지이다.
1. 텍스처를 렌더 대상으로 묶는 것 (D3D11_BIND_RENDER_TARGET)
2. 텍스처를 셰이더 자원으로서 묶는 것 (D3D11_BIND_SHADER_TARGET)
(D3D11) : 파이프라인 결속 플래그

Direct3D에서 텍스처를 사용하려면 텍스처의 초기화 시점에서 그 텍스처의 자원 뷰(resource view)를 생성해야 한다.
따라서 텍스처가 렌더 대상과 셰이더 자원을 사용하기 위해서는 각각의 자원 뷰를 생성해야 한다.
자원 뷰를 생성할 때는 아래 함수들을 이용하여 사용한다.
1. 렌더 대상 : ID3D11RenderTargetView
2. 셰이더 자원 : ID3D11ShaderResourceView

참고로 무형식 지원은 그런 자원이 제공하는 유연성이 꼭 필요한 경우에만 사용하는 것을 권장하며
그 경우를 제외하고는 형식을 완전하게 지정하여 사용하는 것이 좋다.
이유는 형식이 완전하게 지정된 자원은 런타임에서 자원 접근을 최적화 할 수 있기 때문이다.

### 다중 표본화(샘플링)의 이론
일반적으로 선을 픽셀로 이루어진 모니터에 띄우면 계단 현상 (Aliasing)이 발생한다.
이 계단 현상 제거(anti-aliasing)을 위한 기법이 존재하며 그 중에는 초과샘플링(super-sampling) 기법이 있다.

초과샘플링은 버퍼의 해상도보다 4배(가로와 세로 2배)로 크게 할당하여 모니터의 1픽셀이 버퍼의 4픽셀로 할당하며
모니터의 1픽셀을 버퍼의 4픽셀의 평균 색상으로 결정한다.

또 하나의 기법은 다중샘플링(multi-sampling)이며 기본적으로 초과샘플링과 비슷하다.
다중샘플링은 초과샘플링과 마찬가지로 해상도를 4배로 크게 할당하지만 색상은 픽셀 중앙 색상만을 이용하고
부분픽셀의 가시성(해당 값을 위해 부분픽셀당 깊이 스텐실 판정이 발생함)과 포괄도(다각형이 부분픽셀을 덮는 정도)를
이용하여 최종 색상을 결정한다.

참고로 이미지 색상을 계산하는 것은 그래픽 파이프라인에서 가장 계산을 많이 요구하는 단계 중 하나이기 때문에
초과 샘플링에 비해 다중 샘플링의 계산 절감이 크다고 한다.
하지만 초과 샘플링이 계산 요구량이 큰 만큼 기술적으로 더 정확하다.

|계산 비용 요소|초과 샘플링|다중 샘플링|
|:---------:|:------:|:-------:|
|색상|4픽셀의 색상의 평균|픽셀 중앙의 색 + 깊이 스텐실 버퍼 + 부분 픽셀의 포괄도|
|해상도|모니터 해상도의 4배|동일|
|계산 비용|상대적으로 많음|상대적으로 적음|

## 렌더링 파이프라인

### 모형의 표현
일반적으로 Direct3D에서는 고형(solid)의 3차원 물체는 삼각형 메시(mesh) 근사(approximation)해서 표현한다.
이 특징으로 3차원 물체를 이루는 삼각형 메시가 많으면 많을 수록 구체적으로 묘사되지만 삼각형 메시의 처리량이 많아진다.
따라서 사용자 층의 하드웨어 성능에 근거하여 적절한 균형점을 찾을 필요가 있다.

### 색상의 표현



#### Reference  
https://junk-s.tistory.com/47
https://learn.microsoft.com/ko-kr/windows/uwp/graphics-concepts/stencil-buffers

------

## 실전 프로그래밍 편

### Direct3D의 다중 샘플링

### 기능 수준

### Direct3D 초기화
Direct3D 초기화 과정은 크게 아래와 같은 단계들로 구성된다.
(정확히는 4X 다중표본화를 사용하는 전형적인 Direct3D 11 응용 프로그램의 초기화 과정이라고 책에서 소개한다.)

1. D3D11CreateDevice 함수를 이용해 ID3D11Device와 ID3D11DeviceContext를 생성한다.
2. ID3D11Device::CheckMultisampleQualityLevels 메소드를 사용하여 4XMSAA 품질 수준 지원 여부를 점검한다.
3. 생성할 교환 사슬(이중 버퍼링)의 특성을 서술하는 DXGI_SWAP_CHAIN_DESC 구조체를 채운다.
4. 장치를 생성하는데 사용했던 IDXGIFactory 인터페이스를 통해 IDXGISwapChain 인스턴스를 생성한다.
5. 교환 사슬의 후면 버퍼에 대한 렌더 대상 뷰를 생성한다.
6. 깊이, 스텐실 버퍼와 그에 연결되는 깊이, 스텐실 뷰를 생성한다.
7. 렌더 대상 뷰와 깊이, 스텐실 뷰를 Direct3D가 사용할 수 있도록 렌더링 파이프라인의 출력 병합기 단계와 묶는다.
8. 뷰포트를 설정한다.



### 타이밍과 애니메이션